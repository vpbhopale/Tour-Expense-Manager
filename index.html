<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Tour Expense Manager</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&amp;display=swap" rel="stylesheet"/>
<!-- React UMD -->
<script crossorigin="" src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin="" src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<!-- Chart.js for charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<!-- html2canvas and jsPDF for screenshot + PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- XLSX for Excel export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
:root{
  --bg:#eefaf3;
  --card:#ffffffcc;
  --accent:#0f172a;
  --muted:#556070;
  --glass: rgba(255,255,255,0.55);
  --shadow: 0 10px 30px rgba(15,23,42,0.08);
}
*{box-sizing:border-box}
body{
  font-family:'Inter',sans-serif;
  margin:0;
  background: linear-gradient(180deg,#f0fff6 0%, #e9fbf1 100%);
  color:var(--accent);
  min-height:100vh;
}
.container{max-width:800px;margin:20px auto;padding:14px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.title{display:flex;flex-direction:column}
h1{margin:0;font-size:22px}
p.subtitle{margin:0;color:var(--muted);font-size:13px}
.card{
  background:var(--card);
  border-radius:12px;
  padding:12px;
  margin-bottom:12px;
  box-shadow:var(--shadow);
  transition:transform .12s,box-shadow .12s;
}
.card:active{transform:translateY(-2px)}
.row{display:flex;gap:10px;flex-wrap:wrap}
.col{flex:1 1 220px}
.input,select,textarea{width:100%;padding:8px;border:1px solid #d1d5db;border-radius:8px;margin-bottom:8px;font-family:inherit}
button{background:#2563eb;color:white;border:none;padding:9px 12px;border-radius:8px;cursor:pointer;font-weight:600}
.small{font-size:13px;color:var(--muted)}
.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{padding:8px;border-bottom:1px solid #e6eef0;text-align:left;font-size:14px}
.modal-backdrop{position:fixed;inset:0;background:linear-gradient(rgba(255,255,255,0.06), rgba(255,255,255,0.06));backdrop-filter: blur(6px);display:flex;align-items:center;justify-content:center;z-index:60}
.modal{width:min(720px,94%);background:linear-gradient(180deg, rgba(255,255,255,0.55), rgba(255,255,255,0.45));border-radius:12px;padding:16px;box-shadow:0 12px 40px rgba(15,23,42,0.12);backdrop-filter: blur(10px)}
.chart-card{display:flex;align-items:center;gap:12px;cursor:pointer;padding:10px;border-radius:10px;background:linear-gradient(180deg,#ffffff,#f7fff9);border:1px solid rgba(0,0,0,0.03)}
.chart-icon{width:46px;height:46px;border-radius:10px;background:linear-gradient(180deg,#e6fff3,#dcffee);display:flex;align-items:center;justify-content:center;font-weight:700;color:#0b6b3a}
.footer{text-align:center;color:#475569;font-size:13px;margin-top:18px}
.validation{color:#b91c1c;font-size:13px;margin-top:6px}
@media(max-width:800px){ .row{flex-direction:column} .col{flex:1 1 100%} .header{align-items:flex-start} }

body {
  background: url('background.jpg') no-repeat center/cover fixed;
  color: #041b14;
}

.card, .header, .footer {
  background: rgba(255,255,255,0.78) !important;
  backdrop-filter: blur(16px) !important;
  border-radius: 18px !important;
  border: 1px solid rgba(255,255,255,0.55) !important;
  color: #041b14 !important;
}

h1, h2, h3 {
  color: #041b14 !important;
}


:root{
  --sun1: #ffb199;
  --sun2: #ffd2a6;
  --leaf1: #7ed6a1;
  --leaf2: #3fb28a;
}
body::before{
  content: "";
  position: fixed;
  inset: 0;
  background: linear-gradient(180deg, rgba(255,210,180,0.16), rgba(50,90,70,0.06));
  pointer-events: none;
  mix-blend-mode: overlay;
  z-index: 0;
}
button{
  background: linear-gradient(90deg, var(--sun1), var(--sun2));
  color: #042014;
  border: none;
  padding: 10px 14px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 700;
  box-shadow: 0 8px 20px rgba(54,44,44,0.12);
}
button.ghost{
  background: linear-gradient(90deg, rgba(255,255,255,0.65), rgba(255,255,255,0.55));
  color: #042014;
  border: 1px solid rgba(4,32,20,0.06);
  box-shadow: none;
}
@media(max-width:800px){
  .container{padding:12px;margin:10px}
  .header{flex-direction:column;align-items:flex-start;gap:8px}
  .brand img{width:46px;height:46px}
  .card{padding:12px;border-radius:12px}
  button{width:100%;padding:12px;margin-top:6px}
  .row{flex-direction:column}
}
#root{position:relative;z-index:1}


/* Header D hybrid styling */
.custom-header-d{position:relative;z-index:4}
.custom-header-inner-d{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.03));border-radius:14px;padding:8px 12px;}
.logo-badge-d{flex:0 0 auto}
.main-title{color:#041b14}
.sub-title{color:rgba(4,27,20,0.7);font-weight:600}
/* Themed bluish-purple buttons */
.btn-primary{
  background: linear-gradient(90deg, rgba(120,110,255,0.92), rgba(90,70,200,0.92));
  color: #ffffff;
  border: none;
  padding: 10px 14px;
  border-radius: 10px;
  font-weight: 800;
  cursor: pointer;
  box-shadow: 0 8px 20px rgba(90,70,200,0.12);
}
.btn-ghost{
  background: rgba(255,255,255,0.78);
  color: #042014;
  border: 1px solid rgba(4,32,20,0.06);
  padding: 9px 12px;
  border-radius: 10px;
  cursor: pointer;
}
/* Mobile: center header */
@media (max-width:800px){
  .custom-header-inner-d{display:flex;flex-direction:column;align-items:center;text-align:center;gap:8px}
  .controls-right{width:100%;display:flex;justify-content:center;gap:10px}
  .btn-primary, .btn-ghost{width:46%}
  .title-block{text-align:center}
}
/* Ensure main app root is visible and scrollable */
#root{position:relative;z-index:2}
body{min-height:100vh;overflow-y:auto}

body{background:url("background.jpg") no-repeat center top; background-size:100% 100vh; background-size:cover;}


/* REMOVE React's built-in header completely */
.container > h1:first-of-type,
.container > div > h1,
.container > header,
.container > .header,
header, h1.app-title {
    display: none !important;
    height: 0 !important;
    margin: 0 !important;
    padding: 0 !important;
    visibility: hidden !important;
}

/* Add spacing between Add Member and Create Project buttons */
button#addMemberBtn {
    margin-bottom: 12px !important;
}
</style>

<style>
@media (max-width: 768px) {
  #loginScreen {
    flex-direction: column !important;
    padding-top: 80px !important;
  }
  #loginScreen > div:first-child {
    flex: none !important;
    height: 40vh !important;
    padding: 20px !important;
  }
  #loginScreen > div:nth-child(2) {
    flex: none !important;
    height: auto !important;
    padding: 20px !important;
  }
  #loginScreen .login-card {
    width: 90% !important;
    max-width: 95% !important;
    padding: 30px 20px !important;
  }
  #loginScreen input, 
  #loginScreen button {
    max-width: 100% !important;
    font-size: 16px !important;
  }
}
</style>

<style>
@media (max-width: 768px) {
  #loginScreen .left-text {
    font-size:28px !important;
    white-space:nowrap !important;
  }
}
</style>

<style>
.bg-overlay {
  position:fixed;
  top:0;left:0;
  width:100%;height:100%;
  background:linear-gradient(135deg, rgba(0,0,0,0.4), rgba(0,0,0,0.2));
  z-index:-1;
}

/* fade-in animation */
@keyframes fadeInUp {
  from {opacity:0; transform:translateY(40px);}
  to {opacity:1; transform:translateY(0);}
}
.login-card {
  animation: fadeInUp 0.8s ease-out;
}
</style>

</head>
<body>
<div class="bg-overlay"></div>


</div>



<!-- HEADER TOP LEFT -->
<div id="loginHeader" style="position:absolute;top:20px;left:30px;z-index:20;color:white;text-shadow:0 0 6px black;font-family:Inter,sans-serif;">
  <h1 style="margin:0;font-size:32px;">Tour Expense Manager</h1>
  <div style="font-size:16px;">Project created by Vaibhav Bhopale</div>
</div>

<!-- MAIN LOGIN LAYOUT -->
<div id="loginScreen" 
     style="height:100vh;width:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;overflow:hidden;">

  <!-- LEFT PANEL -->
  <div style="flex:1;background:none;
              display:flex;align-items:center;justify-content:center;color:white;
              text-shadow:0 0 10px rgba(0,0,0,0.8);padding:40px;">
      
  </div>

  <!-- RIGHT LOGIN CARD -->
  <div style="flex:1;display:flex;align-items:center;justify-content:center;
              backdrop-filter:blur(10px);background:rgba(255,255,255,0.15);">

      <div class="login-card" style="background:rgba(255,255,255,0.25);backdrop-filter:blur(18px);
                  padding:60px 50px;border-radius:24px;box-shadow:0 25px 45px rgba(0,0,0,0.25);
                  width:650px;max-width:90%;">

          <h2 style="text-align:center;margin-bottom:25px;color:#222;">Login</h2>

          <input type="text" id="loginId" placeholder="Login ID"
                 style="width:100%;max-width:550px;margin:15px auto;display:block;
                        padding:14px;border-radius:10px;border:1px solid #ccc;font-size:18px;">

          <div style="position:relative;width:100%;max-width:550px;margin:auto;">
              <input type="password" id="loginPass" placeholder="Password"
                     style="width:100%;padding:14px;border-radius:10px;
                            border:1px solid #ccc;font-size:18px;">
              <span onclick="togglePassword()" 
                    style="position:absolute;right:15px;top:50%;transform:translateY(-50%);
                           cursor:pointer;font-size:14px;color:#333;text-decoration:underline;">
                    Show
              </span>
          </div>

          <button onclick="validateLogin()" 
                  style="width:100%;max-width:550px;margin:25px auto 10px;display:block;
                         padding:14px;border:none;background:#2563eb;color:white;
                         border-radius:10px;font-size:20px;font-weight:600;">
              Login
          </button>

          <div id="loginError" style="color:red;text-align:center;margin-top:10px;display:none;">
            Invalid Login ID or Password
          </div>

      </div>
  </div>
</div>

<script>
function togglePassword(){
    const f = document.getElementById("loginPass");
    f.type = f.type === "password" ? "text" : "password";
}
</script>
>
</div>

<div class="custom-header-d" id="customHeaderD" style="display:none; display:none; position:relative; z-index:4; margin:12px auto 6px; max-width:800px;">
<div class="custom-header-inner-d" style="display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 12px;">
<div class="brand-left" style="display:flex;align-items:center;gap:12px;">
<div class="logo-badge-d" style="width:56px;height:56px;display:flex;align-items:center;justify-content:center;border-radius:14px;background:rgba(255,255,255,0.48);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.5);box-shadow:0 6px 20px rgba(120,110,255,0.40),0 0 10px rgba(90,70,200,0.25);">
</div>
<div class="title-block" style="display:flex;flex-direction:column;line-height:1;">
<div class="main-title" style="font-size:18px;font-weight:800;color:#041b14;">Tour Expense Manager</div>
<div class="tagline" style="font-size:14px;color:#334;">Project designed by Vaibhav Bhopale</div>
<div class="sub-title" style="font-size:12px;color:rgba(4,27,20,0.68);">Smart travel expense settlement</div>
</div>
</div>
<div class="controls-right" style="display:flex;gap:8px;align-items:center;">
<button class="btn-primary" id="newProjectBtnHeader" style="">+ New Project</button>
<button class="btn-ghost" id="backupBtnHeader" style="">Backup</button>
</div>
</div>
</div>
<div id="root" style="display:none;"></div>
<script>
document.addEventListener("DOMContentLoaded", ()=> {
  const e = React.createElement;
  const Chart = window.Chart;
  const { jsPDF } = window.jspdf;

  const STORAGE_KEY = "TEM_FINAL_OPTIONB_CHARTS_V1";
  function uid(){return Math.random().toString(36).slice(2,9);}
  function saveAll(data){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
  function loadAll(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");}catch{return [];} }

  /* ---------- App ---------- */
  function App(){
    const [projects,setProjects] = React.useState(()=> loadAll());
    const [activeId,setActiveId] = React.useState(null);
    React.useEffect(()=> saveAll(projects), [projects]);

    function addProject(p){ setProjects(prev=> [...prev,p]); }
    function updateProject(updated){ setProjects(prev=> prev.map(x=> x.id===updated.id? updated : x)); }
    function deleteProject(id){ if(confirm("Delete project?")) setProjects(prev=> prev.filter(x=> x.id!==id)); }

    const active = projects.find(p=> p.id===activeId) || null;

    return e("div",{className:"container"},
      e("div",{className:"header"},
        e("div",{className:"title"}, e("h1",null, , "Tour Expense Manager"), e("p",{className:"subtitle"},"")),
        e("div",null, active? e("button",{onClick:()=>setActiveId(null)},"Back to Projects") : null)
      ),
      !active && e(ProjectList,{projects,addProject,openProject:id=>setActiveId(id),deleteProject}),
      active && e(ProjectView,{project:active,updateProject,back:()=>setActiveId(null)}),
      e("div",{className:"footer"},"Project designed by Vaibhav Bhopale")
    );
  }

  /* ---------- ProjectList ---------- */
  function ProjectList({projects,addProject,openProject,deleteProject}){
    const [name,setName] = React.useState("");
    const [members,setMembers] = React.useState([]);
    const [mname,setMname] = React.useState("");

    function addMember(){
      const nm = (mname||"").trim();
      if(!nm) return alert("Enter member name");
      setMembers(prev=> [...prev, { id: uid(), name: nm, advances: [], advance: 0 }]);
      setMname("");
    }

    function createProject(){
      const n = (name||"").trim();
      if(!n) return alert("Enter project name");
      if(members.length === 0) return alert("Add at least one member");
      addProject({ id: uid(), name: n, members, expenses: [], advances: [] });
      setName(""); setMembers([]);
    }

    function exportAll(){
      const blob = new Blob([JSON.stringify(projects)], { type: "application/json" });
      const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "tour_projects_all.json"; a.click();
    }

    function importAll(ev){
      const f = ev.target.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = e2 => {
        try{
          const arr = JSON.parse(e2.target.result);
          if(!Array.isArray(arr)) return alert("Invalid JSON");
          arr.forEach(p => addProject(p));
        }catch(err){ alert("Invalid JSON file"); }
      };
      r.readAsText(f);
    }

    return e("div",null,
      e("div",{className:"card"},
        e("h2",null,"Create New Project"),
        e("label",null,"Project Name"),
        e("input",{className:"input",value:name,onChange:ev=>setName(ev.target.value),placeholder:"e.g., Goa Trip"}),
        e("div",{className:"row"},
          e("div",{className:"col"},
            e("label",null,"Member Name"),
            e("input",{className:"input",value:mname,onChange:ev=>setMname(ev.target.value),placeholder:"Type and click Add"}),
            e("button",{onClick:addMember},"Add Member")
          ),
          e("div",{className:"col"},
            e("label",null,"Members"),
            e("ul",null,members.map(m=> e("li",{key:m.id}, m.name)))
          )
        ),
        e("div",null, e("button",{onClick:createProject},"Create Project"))
      ),
      projects.map(p=> e("div",{key:p.id,className:"card"},
        e("h3",null,p.name),
        e("div",null, e("button",{onClick:()=>openProject(p.id)},"Open / Edit"), " ", e("button",{onClick:()=>deleteProject(p.id)},"Delete"))
      )),

      e("div",{className:"card"},
        e("h3",null,"Backup / Restore"),
        e("div",{className:"row"},
          e("div",{className:"col"}, e("button",{onClick:exportAll},"Export All Projects (JSON)"), e("input",{type:"file", accept:".json", onChange:importAll})),
          e("div",{className:"col"}, e("small",{className:"small"},"You can export individual projects inside project view."))
        )
      )
    );
  }

  /* ---------- ProjectView ---------- */
  function ProjectView({project,updateProject,back}){
    const [p,setP] = React.useState(()=> deepClone(project));
    const [showCategoryChart,setShowCategoryChart] = React.useState(false);
    const [showMemberChart,setShowMemberChart] = React.useState(false);
    React.useEffect(()=> updateProject(p), [p]);

    function deepClone(x){ return JSON.parse(JSON.stringify(x||{})); }

    function addAdvance(a){
      if(!a || !a.paidBy || !a.paidTo || !(a.amount>0)) return alert("Invalid advance");
      setP(prev=>{
        const np = deepClone(prev);
        np.advances = np.advances || [];
        np.advances.push({ id: uid(), paidBy: a.paidBy, paidTo: a.paidTo, amount: a.amount, date: (new Date()).toLocaleDateString() });
        np.members = (np.members || []).map(m=>{
          if(m.id === a.paidBy){
            m.advances = m.advances || [];
            m.advances.push(a.amount);
            m.advance = (m.advances || []).reduce((s,v)=> s + (+v||0), 0);
          }
          return m;
        });
        return np;
      });
    }

    function addExpense(exp){
      if(!exp) return alert("Invalid expense");
      setP(prev=>{
        const np = deepClone(prev);
        np.expenses = np.expenses || [];
        np.expenses.push(exp);
        return np;
      });
    }

    function deleteExpense(id){
      if(!confirm("Delete expense?")) return;
      setP(prev => ({ ...prev, expenses: (prev.expenses||[]).filter(x=>x.id!==id) }));
    }

    function exportExcel(){
      try{
        const wb = XLSX.utils.book_new();
        const memRows = (p.members||[]).map(m=> ({ Name: m.name, Advance: m.advance||0 }));
        const expRows = (p.expenses||[]).map(x=> ({ Date: x.date, Description: x.description, Category: x.category, PaidBy: (p.members||[]).find(m=>m.id===x.paidBy)?.name||"", Amount: x.amount }));
        const advRows = (p.advances||[]).map(a=> ({ Date: a.date, PaidBy: (p.members||[]).find(m=>m.id===a.paidBy)?.name||"", PaidTo: (p.members||[]).find(m=>m.id===a.paidTo)?.name||"", Amount: a.amount }));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(memRows), `${p.name}_Members`.slice(0,31));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(expRows), `${p.name}_Expenses`.slice(0,31));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(advRows), `${p.name}_Advances`.slice(0,31));
        XLSX.writeFile(wb, `${p.name.replace(/\s+/g,"_")}_Project.xlsx`);
      }catch(err){ alert("Export failed: "+err.message); }
    }

    // Export current project as JSON file
    function exportJSON_currentProject(){
      try{
        const blob = new Blob([JSON.stringify(p, null, 2)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${p.name.replace(/\s+/g,"_") || "project"}.json`;
        a.click();
      }catch(err){ alert("Export JSON failed: " + (err.message || err)); }
    }

    async function exportPDF(){
      try{
        const settlement = computeSettlement(p);
        const doc = new jsPDF({orientation: "landscape"});
        doc.setFontSize(14);
        doc.text(`Tour Expense Manager — Settlement`, 14, 14);
        doc.setFontSize(11);
        let y = 24;
        doc.text(`Project: ${p.name || ""}`, 14, y); y += 8;
        doc.setFontSize(10);
        doc.text("Member | Paid | Owed | AdvanceGiven | UsedFromAdvance | FinalNet | Remark", 14, y); y += 6;

        settlement.members.forEach(m=>{
          const line = `${m.name} | ${m.paid.toFixed(2)} | ${m.owed.toFixed(2)} | ${m.totalAdvanceGiven.toFixed(2)} | ${m.usedFromAdvance.toFixed(2)} | ${m.finalNet.toFixed(2)} | ${shorten(settlement.remarks[m.id]||"")}`;
          const parts = doc.splitTextToSize(line, 270);
          parts.forEach(pLine=>{ doc.text(pLine, 14, y); y+=6; if(y>180){ doc.addPage(); y=14; }});
        });

        // Prepare transfers HTML (attach to DOM temporarily for html2canvas to compute fonts/styles)
        const transfersHtml = document.createElement("div");
        transfersHtml.style.padding = "10px";
        transfersHtml.style.fontFamily = "Inter, Arial, sans-serif";
        transfersHtml.style.width = "720px";
        transfersHtml.style.background = "#fff";
        transfersHtml.innerHTML = `<h3>Transfers</h3>`;
        if((settlement.transactions || []).length === 0){
          const pEl = document.createElement("p"); pEl.textContent = "No transfers required.";
          transfersHtml.appendChild(pEl);
        } else {
          const ul = document.createElement("ul");
          (settlement.transactions || []).forEach(t=>{
            const li = document.createElement("li");
            if(t.type === "advance_return") li.textContent = `${t.from} returns ₹${t.amount.toFixed(2)} to ${t.to} (unused advance)`;
            else if(t.type === "advance_deficit") li.textContent = `${t.from} pays ₹${t.amount.toFixed(2)} to ${t.to} (advance shortfall)`;
            else li.textContent = `${t.from} → ${t.to}: ₹${t.amount.toFixed(2)}`;
            ul.appendChild(li);
          });
          transfersHtml.appendChild(ul);
        }

        // attach to body offscreen
        transfersHtml.style.position = "fixed";
        transfersHtml.style.left = "-9999px";
        document.body.appendChild(transfersHtml);
        const canvas = await html2canvas(transfersHtml, { scale: 2 });
        document.body.removeChild(transfersHtml);

        const imgData = canvas.toDataURL("image/png");
        doc.addPage();
        const pageWidth = doc.internal.pageSize.getWidth();
        const margin = 10;
        const imgW = pageWidth - margin*2;
        const imgH = (canvas.height / canvas.width) * imgW;
        doc.addImage(imgData, "PNG", margin, 10, imgW, imgH);
        doc.save(`${p.name.replace(/\s+/g,"_") || "project"}_settlement.pdf`);
      }catch(err){
        alert("PDF failed: " + (err && err.message ? err.message : err));
      }
    }

    // helper to shorten long remarks for PDF
    function shorten(s){
      if(!s) return "";
      if(s.length <= 80) return s;
      return s.slice(0,77) + "...";
    }

    // render
    return e("div",null,
      e("div",{className:"card",style:{display:"flex",alignItems:"center",justifyContent:"space-between"}},
        e("div",null,e("h2",null,p.name), e("div",{className:"small"}, `${(p.members||[]).length} members — Expenses: ${(p.expenses||[]).length}`)),
        e("div",{style:{display:"flex",gap:8}},
          e("button",{onClick:back},"← Projects"),
          e("button",{onClick:exportExcel},"Export Excel"),
          e("button",{onClick:exportJSON_currentProject},"Export JSON"),
          e("button",{onClick:exportPDF},"Export PDF")
        )
      ),
      e("div",{className:"row"},
        e("div",{className:"col"},
          e(MemberTable,{p})
        ),
        e("div",{className:"col"},
          e("div",{className:"card"},
            e("h3",null,"Charts"),
            e("div",{className:"row"},
              e("div",{className:"chart-card", onClick:()=>setShowCategoryChart(true), role:"button", tabIndex:0},
                e("div",{className:"chart-icon"},"C"),
                e("div",null,e("strong",null,"Category Chart"), e("div",{className:"small"},"Click to open category-wise pie chart"))
              ),
              e("div",{className:"chart-card", onClick:()=>setShowMemberChart(true), role:"button", tabIndex:0},
                e("div",{className:"chart-icon"},"M"),
                e("div",null,e("strong",null,"Member Chart"), e("div",{className:"small"},"Click to open member-wise owed pie chart"))
              )
            )
          )
        )
      ),
      e("div",null,
        e(AdvanceForm,{members: p.members||[], onAdd: addAdvance}),
        e(ExpenseForm,{members: p.members||[], onAdd: addExpense})
      ),
      e(ExpenseList,{p, onDelete: deleteExpense}),
      e(TotalCard,{p}),
      e(SettlementPanel,{p}),
      // Chart modals
      showCategoryChart && e(ChartsModal,{p, type:"category", onClose:()=>setShowCategoryChart(false)}),
      showMemberChart && e(ChartsModal,{p, type:"member", onClose:()=>setShowMemberChart(false)})
    );
  }

  /* ---------- MemberTable ---------- */
  function MemberTable({p}){
    const members = p.members || [];
    function calcBalance(id){
      let paid = 0, owed = 0;
      (p.expenses||[]).forEach(ex=>{ if(ex.paidBy===id) paid += +ex.amount||0; owed += +(ex.splits && ex.splits[id] || 0); });
      const m = members.find(mm=>mm.id===id) || { advance:0 };
      const adv = +(m.advance||0);
      return (paid + adv - owed);
    }
    return e("div",{className:"card"},
      e("h3",null,"Members & Balances"),
      e("table",{className:"table"},
        e("thead",null, e("tr",null, e("th",null,"Member"), e("th",null,"Total Advance"), e("th",null,"Net Balance"))),
        e("tbody",null, members.map(m=> e("tr",{key:m.id}, e("td",null,m.name), e("td",null,(m.advance||0).toFixed(2)), e("td",null, calcBalance(m.id).toFixed(2)) )))
      )
    );
  }

  /* ---------- AdvanceForm ---------- */
  function AdvanceForm({members, onAdd}){
    const [paidBy,setPaidBy] = React.useState(members[0]?.id || "");
    const [paidTo,setPaidTo] = React.useState(members[0]?.id || "");
    const [amt,setAmt] = React.useState("");

    React.useEffect(()=> {
      if(members.length){
        if(!members.find(m=>m.id===paidBy)) setPaidBy(members[0].id);
        if(!members.find(m=>m.id===paidTo)) setPaidTo(members[0].id);
      }
    }, [members]);

    function submit(){
      const amount = parseFloat(amt);
      if(!paidBy || !paidTo) return alert("Select Paid By / Paid To");
      if(!amount || amount <= 0) return alert("Enter valid amount");
      onAdd({ paidBy, paidTo, amount });
      setAmt("");
    }

    return e("div",{className:"card"},
      e("h3",null,"Add Advance (Paid By → Paid To)"),
      e("div",{className:"row"},
        e("div",{className:"col"}, e("label",null,"Paid By"), e("select",{className:"input",value:paidBy,onChange:ev=>setPaidBy(ev.target.value)}, members.map(m=> e("option",{key:m.id,value:m.id}, m.name)))),
        e("div",{className:"col"}, e("label",null,"Paid To"), e("select",{className:"input",value:paidTo,onChange:ev=>setPaidTo(ev.target.value)}, members.map(m=> e("option",{key:m.id,value:m.id}, m.name))))
      ),
      e("label",null,"Amount"), e("input",{className:"input",type:"number", value:amt, onChange:ev=>setAmt(ev.target.value)}),
      e("div",null, e("button",{onClick:submit},"Add Advance"))
    );
  }

  /* ---------- ExpenseForm ---------- */
  function ExpenseForm({members, onAdd}){
    const [date,setDate] = React.useState(new Date().toISOString().slice(0,10));
    const [desc,setDesc] = React.useState("");
    const [category,setCategory] = React.useState("Food");
    const [otherCat,setOtherCat] = React.useState("");
    const [paidBy,setPaidBy] = React.useState(members[0]?.id || "");
    const [amount,setAmount] = React.useState("");
    const [splitType,setSplitType] = React.useState("Equal");
    const [custom,setCustom] = React.useState({});
    const [validation,setValidation] = React.useState("");

    React.useEffect(()=> { if(members.length && !members.find(m=>m.id===paidBy)) setPaidBy(members[0].id); }, [members]);

    function setCustomVal(id,val){ setCustom(prev=> ({...prev, [id]: +(val||0)})); }

    function submit(){
      setValidation("");
      const amt = parseFloat(amount);
      const cat = (category === "Other") ? (otherCat||"").trim() : category;
      if(!date || !desc.trim() || !cat || !paidBy || !(amt > 0)){
        setValidation("Please enter all fields");
        return;
      }
      let splits = {};
      if(splitType === "Equal"){
        const per = +(amt / (members.length||1)).toFixed(2);
        members.forEach(m=> splits[m.id] = per);
      } else {
        const sum = members.reduce((s,m)=> s + ((custom[m.id]||0)), 0);
        if(Math.abs(sum - amt) > 0.01){
          setValidation(`Custom splits must total ${amt.toFixed(2)} (current ${sum.toFixed(2)})`);
          return;
        }
        members.forEach(m=> splits[m.id] = +(custom[m.id]||0));
      }

      const exp = { id: uid(), date, description: desc.trim(), category: cat, paidBy, amount: amt, splitType, splits };
      onAdd(exp);
      setDesc(""); setAmount(""); setCategory("Food"); setOtherCat(""); setSplitType("Equal"); setCustom({}); setValidation("");
      setDate(new Date().toISOString().slice(0,10));
    }

    return e("div",{className:"card"},
      e("h3",null,"Add Expense"),
      e("div",{className:"row"},
        e("div",{className:"col"}, e("label",null,"Date"), e("input",{className:"input",type:"date", value:date, onChange:ev=>setDate(ev.target.value)})),
        e("div",{className:"col"}, e("label",null,"Amount"), e("input",{className:"input",type:"number", value:amount, onChange:ev=>setAmount(ev.target.value)}))
      ),
      e("label",null,"Description"), e("input",{className:"input",value:desc,onChange:ev=>setDesc(ev.target.value)}),
      e("label",null,"Category"),
      e("select",{className:"input",value:category,onChange:ev=>setCategory(ev.target.value)},
        e("option",{value:"Food"},"Food"),
        e("option",{value:"Fuel"},"Fuel"),
        e("option",{value:"Travel"},"Travel"),
        e("option",{value:"Accommodation"},"Accommodation"),
        e("option",{value:"Sport"},"Sport"),
        e("option",{value:"Other"},"Other")
      ),
      category==="Other" && e("input",{className:"input",placeholder:"Specify category", value:otherCat, onChange:ev=>setOtherCat(ev.target.value)}),
      e("label",null,"Paid By"),
      e("select",{className:"input",value:paidBy,onChange:ev=>setPaidBy(ev.target.value)}, members.map(m=> e("option",{key:m.id,value:m.id}, m.name)) ),
      e("label",null,"Split Type"),
      e("select",{className:"input",value:splitType,onChange:ev=>setSplitType(ev.target.value)}, e("option",{value:"Equal"},"Equally"), e("option",{value:"Custom"},"Custom")),
      splitType==="Custom" && e("div",null,
        e("small",{className:"small"},"Enter each member's share (sum must equal Amount)"),
        members.map(m=> e("div",{key:m.id,className:"row"}, e("div",{className:"col"}, e("label",null,m.name), e("input",{className:"input",type:"number", value:(custom[m.id]===undefined? "": custom[m.id]), onChange:ev=>setCustomVal(m.id, ev.target.value)})) ))
      ),
      e("div",null, e("button",{onClick:submit},"Add Expense"), validation && e("div",{className:"validation"}, validation))
    );
  }

  /* ---------- ExpenseList ---------- */
  function ExpenseList({p, onDelete}){
    const ex = p.expenses || [];
    return e("div",{className:"card"},
      e("h3",null,"Expenses"),
      e("table",{className:"table"},
        e("thead",null, e("tr",null, e("th",null,"Date"), e("th",null,"Description"), e("th",null,"Category"), e("th",null,"Paid By"), e("th",null,"Amount"), e("th",null,"Action"))),
        e("tbody", null, ex.map(x=> e("tr",{key:x.id}, e("td",null,x.date), e("td",null,x.description), e("td",null,x.category), e("td",null,(p.members||[]).find(m=>m.id===x.paidBy)?.name||""), e("td",null,(x.amount||0).toFixed(2)), e("td",null,e("button",{onClick:()=>onDelete(x.id)},"Delete")) )))
      )
    );
  }

  /* ---------- TotalCard ---------- */
  function TotalCard({p}){
    const total = (p.expenses||[]).reduce((s,x)=> s + (+x.amount||0), 0);
    return e("div",{className:"card"}, e("h3",null,"Total Expenditure"), e("div",null, `₹ ${total.toFixed(2)}`) );
  }

  
  
  
  
  /* ---------- Settlement core Option B (FinalNet = AdvanceGiven - Owed) WITH EXPENSE SETTLEMENT + UNUSED RETURNS ---------- */
function computeSettlement(p){
    const members = (p.members||[]).map(m=>{
        let paid = 0, owed = 0;
        (p.expenses||[]).forEach(ex=>{
            if(ex.paidBy===m.id) paid += +ex.amount||0;
            owed += +(ex.splits && ex.splits[m.id] || 0);
        });
        return { id:m.id, name:m.name, paid:+paid, owed:+owed };
    });

    // adv totals by payer
    const advTotals = {};
    (p.advances||[]).forEach(a=>{
        if(!a || !a.paidBy) return;
        advTotals[a.paidBy] = (advTotals[a.paidBy] || 0) + (+a.amount || 0);
    });

    const memberInfo = {};
    members.forEach(m=>{
        const totAdv = +(advTotals[m.id] || 0);
        memberInfo[m.id] = { ...m, totalAdvanceGiven: totAdv, usedFromAdvance: 0, finalNet: 0 };
    });

    // usedFromAdvance and finalNet as per rule
    Object.keys(memberInfo).forEach(id=>{
        const mi = memberInfo[id];
        mi.usedFromAdvance = +Math.min(mi.totalAdvanceGiven, mi.owed).toFixed(2);
        mi.finalNet = +((mi.totalAdvanceGiven || 0) - (mi.owed || 0)).toFixed(2);
    });

    // identify main expense payer (highest paid)
    const mainPayer = Object.values(memberInfo).sort((a,b)=> b.paid - a.paid)[0] || null;

    const transactions = [];

    // 1) Expense settlements: non-advance members pay their owed share to expense payers
    // For each expense, map owed per (paidBy -> nonGiver) aggregate
    const expenseOwedToPayer = {}; // key payerId -> { nonGiverId: amount }
    (p.expenses||[]).forEach(ex=>{
        Object.keys(ex.splits||{}).forEach(mid=>{
            const amt = +(ex.splits[mid]||0);
            // if member didn't give advance (advTotals[mid] is 0 or undefined) and mid != paidBy, they owe to payer
            if(mid !== ex.paidBy && !(advTotals[mid] > 0)){
                expenseOwedToPayer[ex.paidBy] = expenseOwedToPayer[ex.paidBy] || {};
                expenseOwedToPayer[ex.paidBy][mid] = (expenseOwedToPayer[ex.paidBy][mid] || 0) + amt;
            }
        });
    });

    // Create expense settlement transactions (non-givers -> payer)
    Object.keys(expenseOwedToPayer).forEach(payerId=>{
        const map = expenseOwedToPayer[payerId];
        Object.keys(map).forEach(nid=>{
            const amt = +map[nid].toFixed(2);
            if(amt > 0.005){
                const payerName = memberInfo[payerId].name;
                const nidName = memberInfo[nid].name;
                transactions.push({ type: "expense_settlement", fromId: nid, from: nidName, toId: payerId, to: payerName, amount: amt });
                // adjust finals: payer receives, non-giver pays
                memberInfo[payerId].finalNet = +(memberInfo[payerId].finalNet - amt).toFixed(2); // receiving reduces advance balance held
                memberInfo[nid].finalNet = +(memberInfo[nid].finalNet + amt).toFixed(2); // paying makes them less negative (or more positive)
            }
        });
    });

    // 2) Unused advance returns: mainPayer (holder) returns unused advance to advance givers
    // Compute unused for each giver: unused = totalAdvanceGiven - usedFromAdvance
    const advanceGivers = Object.values(memberInfo).filter(m=> m.totalAdvanceGiven > 0);
    if(mainPayer && advanceGivers.length){
        advanceGivers.forEach(g=>{
            const unused = +( (g.totalAdvanceGiven || 0) - (g.usedFromAdvance || 0) ).toFixed(2);
            if(unused > 0.005){
                // transaction: mainPayer -> giver
                transactions.push({ type: "unused_return", fromId: mainPayer.id, from: mainPayer.name, toId: g.id, to: g.name, amount: unused });
                // reflect in finals: mainPayer pays out unused, so reduce its balance
                memberInfo[mainPayer.id].finalNet = +(memberInfo[mainPayer.id].finalNet - unused).toFixed(2);
                memberInfo[g.id].finalNet = +(memberInfo[g.id].finalNet + unused).toFixed(2);
            }
        });
    }

    // Build remarks per person: only concerned lines
    const remarks = {};
    Object.values(memberInfo).forEach(mi=>{
        const parts = [];
        parts.push(`Advance Given: ₹${mi.totalAdvanceGiven.toFixed(2)}`);
        parts.push(`UsedFromAdvance: ₹${mi.usedFromAdvance.toFixed(2)}`);
        parts.push(`FinalNet (Advance - Owed): ₹${mi.finalNet.toFixed(2)}`);

        // expense settlements related to this person
        const expRelated = transactions.filter(t=> t.type==="expense_settlement" && (t.fromId===mi.id || t.toId===mi.id));
        expRelated.forEach(t=>{
            if(t.fromId===mi.id) parts.push(`Pays ₹${t.amount.toFixed(2)} to ${t.to} (expense share)`);
            if(t.toId===mi.id) parts.push(`Receives ₹${t.amount.toFixed(2)} from ${t.from} (expense share)`);
        });

        // unused advance returns related to this person
        const unusedRelated = transactions.filter(t=> t.type==="unused_return" && (t.fromId===mi.id || t.toId===mi.id));
        unusedRelated.forEach(t=>{
            if(t.fromId===mi.id) parts.push(`Pays ₹${t.amount.toFixed(2)} to ${t.to} (unused advance return)`);
            if(t.toId===mi.id) parts.push(`Receives ₹${t.amount.toFixed(2)} from ${t.from} (unused advance return)`);
        });

        if(parts.length===3 && Math.abs(mi.finalNet) < 0.01) parts.push("Settled");
        remarks[mi.id] = parts.join(" | ");
    });

    const resultMembers = Object.values(memberInfo).map(x=> ({
        id:x.id, name:x.name, paid:+x.paid, owed:+x.owed,
        totalAdvanceGiven:+x.totalAdvanceGiven, usedFromAdvance:+x.usedFromAdvance, finalNet:+x.finalNet
    }));

    return { members: resultMembers, transactions, remarks };
}

  /* ---------- SettlementPanel (renders transfers) ---------- */
function SettlementPanel({p}){
    const res = computeSettlement(p);
    return e("div",{className:"card", id:"settlement-area"},
      e("h3",null,"Settlement Summary"),
      e("table",{className:"table"},
        e("thead",null,e("tr",null,
          e("th",null,"Member"),
          e("th",null,"Paid"),
          e("th",null,"Owed"),
          e("th",null,"Advance Given"),
          e("th",null,"UsedFromAdvance"),
          e("th",null,"FinalNet"),
          e("th",null,"Remark")
        )),
        e("tbody",null,res.members.map(m=> e("tr",{key:m.id},
          e("td",null,m.name),
          e("td",null,m.paid.toFixed(2)),
          e("td",null,m.owed.toFixed(2)),
          e("td",null,m.totalAdvanceGiven.toFixed(2)),
          e("td",null,m.usedFromAdvance.toFixed(2)),
          e("td",null,m.finalNet.toFixed(2)),
          e("td",null,res.remarks[m.id]||"Settled")
        )))
      ),
      e("div",{style:{marginTop:8}},
        res.transactions.length ? e("div",null,
          e("strong",null,"Transfers:"),
          e("ul",null,
            res.transactions.map((t,i)=> e("li",{key:i}, `${t.from} → ${t.to}: ₹${t.amount.toFixed(2)}`))
          )
        ) : e("p",null,"All settled — no transfers needed.")
      )
    );
}

function Modal({onClose, title, children}){
    return e("div",{className:"modal-backdrop", onClick: (ev)=> { if(ev.target.className && ev.target.className.indexOf('modal-backdrop')>=0) onClose(); }},
      e("div",{className:"modal"},
        e("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}},
          e("h3",null,title),
          e("button",{onClick:onClose},"Close")
        ),
        children
      )
    );
  }

  function ChartsModal({p, type, onClose}){
    const canvasRef = React.useRef(null);
    React.useEffect(()=> {
      if(!canvasRef.current) return;
      // prepare data
      if(type === "category"){
        const sums = {};
        (p.expenses||[]).forEach(x=> { sums[x.category] = (sums[x.category]||0) + (+x.amount||0); });
        const labels = Object.keys(sums);
        const data = labels.map(l=> sums[l]);
        createPie(canvasRef.current, labels, data, "Category-wise Expenditure");
      } else {
        const owedMap = {};
        (p.members||[]).forEach(m=> owedMap[m.name] = 0);
        (p.expenses||[]).forEach(ex=>{
          Object.keys(ex.splits||{}).forEach(id=>{
            const m = (p.members||[]).find(mm=>mm.id===id);
            if(m) owedMap[m.name] = (owedMap[m.name]||0) + (+ex.splits[id] || 0);
          });
        });
        const labels = Object.keys(owedMap);
        const data = labels.map(l=> owedMap[l]);
        createPie(canvasRef.current, labels, data, "Member-wise Owed (Expenditure)");
      }
      return ()=> { if(canvasRef.current && canvasRef.current.__chart){ try{ canvasRef.current.__chart.destroy(); }catch{} } };
    }, [p, type]);

    return e(Modal,{onClose, title: type==="category"? "Category Chart": "Member Chart"},
      e("div",null, e("canvas",{ref:canvasRef, width:640, height:320}))
    );
  }

  // createPie uses Chart.js
  function createPie(canvas, labels, data, title){
    if(canvas.__chart) { try{ canvas.__chart.destroy(); }catch{} }
    const colors = labels.map((_,i)=> {
      const hue = Math.round((i*47) % 360);
      return `hsl(${hue} 60% 60%)`;
    });
    canvas.__chart = new Chart(canvas, {
      type: "pie",
      data: { labels, datasets: [{ data, backgroundColor: colors }]},
      options: { plugins: { title: { display: true, text: title } } }
    });
  }

  /* ---------- Mount App ---------- */
  ReactDOM.createRoot(document.getElementById("root")).render(e(App));
});
</script>
<script>if('</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  // hook header buttons to existing elements in app if available
  var npHeader = document.getElementById('newProjectBtnHeader');
  var bkHeader = document.getElementById('backupBtnHeader');
  function hook(){
    var np = document.getElementById('newProjectBtn');
    var bk = document.getElementById('backupBtn');
    if(npHeader && np){ npHeader.onclick = function(){ np.click(); } }
    if(bkHeader && bk){ bkHeader.onclick = function(){ bk.click(); } }
  }
  // try immediately and then again after a small delay (in case React mounts later)
  hook();
  setTimeout(hook, 800);
});
</script>

<script>
function validateLogin() {
    const id = document.getElementById("loginId").value.trim();
    const pass = document.getElementById("loginPass").value.trim();
    if (id === "vpbhopale" && pass === "Dhanashree@12345") {
        const h=document.getElementById("loginHeader"); if(h) h.style.display="none";

        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("root").style.display = "block";
        document.getElementById("customHeaderD").style.display = "block";
    } else {
        document.getElementById("loginError").style.display = "block";
    }
}
document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("root").style.display = "none";
    const header = document.getElementById("customHeaderD");
    if (header) header.style.display = "none";
});
</script>

</body>
</html>
